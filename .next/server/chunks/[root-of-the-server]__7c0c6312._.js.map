{"version":3,"sources":["../../../lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\n\nexport const db =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: ['query'],\n  });\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = db;\n\n// --- THE COMPATIBILITY LAYER ---\n\nexport function getSql() {\n  return async (query: string, params: any[] = []) => {\n    // 1. Convert Postgres syntax ($1, $2, etc) to MySQL syntax (?)\n    let mysqlQuery = query.replace(/\\$\\d+/g, '?');\n\n    // 2. Convert Postgres 'ILIKE' (Case Insensitive) to MySQL 'LIKE' (Default is case insensitive)\n    mysqlQuery = mysqlQuery.replace(/ILIKE/gi, 'LIKE');\n\n    // 3. Remove \"RETURNING *\" statements\n    // MySQL crashes if you try to use RETURNING, so we strip it out.\n    // WARNING: This means INSERT/UPDATE operations won't return the new data immediately.\n    mysqlQuery = mysqlQuery.replace(/RETURNING \\*|RETURNING \\w+/gi, '');\n\n    try {\n      // 4. Execute the raw query using Prisma\n      // Note: We use db.$queryRawUnsafe because we are manually building the query string\n      const result = await db.$queryRawUnsafe(mysqlQuery, ...params);\n      \n      // 5. Ensure we return an array (Prisma sometimes returns objects for metadata)\n      if (Array.isArray(result)) {\n        return result;\n      } \n      \n      // If it's an INSERT/UPDATE result in MySQL, it's not an array of rows.\n      // We return an empty array to prevent the app from crashing when it tries to read result[0].\n      return [];\n      \n    } catch (error) {\n      console.error(\"SQL Adapter Error:\", error);\n      throw error;\n    }\n  };\n}\n"],"names":[],"mappings":"wrCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAIO,IAAM,EAFP,AAGJ,EAHI,CAAA,CAGY,MAAM,EACtB,IAAI,EAAA,YAAY,CAAC,CACf,IAAK,CAAC,QACR,AADgB,GAOX,SAAS,IACd,OAAO,MAAO,EAAe,EAAgB,EAAE,IAE7C,IAAI,EAAa,EAAM,OAAO,CAAC,SAAU,KAQzC,EAAa,CALb,EAAa,EAAW,OAAO,CAAC,UAAW,OAAA,EAKnB,OAAO,CAAC,+BAAgC,IAEhE,GAAI,CAGF,IAAM,EAAS,MAAM,EAAG,eAAe,CAAC,KAAe,GAGvD,GAAI,MAAM,OAAO,CAAC,GAChB,MADyB,CAClB,EAKT,MAAO,EAAE,AAEX,CAAE,MAAO,EAAO,CAEd,MADA,QAAQ,KAAK,CAAC,qBAAsB,GAC9B,CACR,CACF,CACF"}