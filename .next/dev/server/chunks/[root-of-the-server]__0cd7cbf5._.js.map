{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/lib/session.ts"],"sourcesContent":["import { cookies } from \"next/headers\"\nimport { jwtVerify, SignJWT } from \"jose\"\n\nconst JWT_SECRET = new TextEncoder().encode(process.env.JWT_SECRET || \"your-secret-key-change-in-production\")\n\nexport interface SessionPayload {\n  userId: string\n  email: string\n  role: \"client\" | \"nutritionist\" | \"admin\";\n}\n\nexport async function createSession(payload: SessionPayload): Promise<string> {\n  // ðŸ’¡ FIX: Spread payload into a new object to satisfy Type 'JWTPayload' requirements\n  const token = await new SignJWT({ ...payload })\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setExpirationTime(\"7d\")\n    .sign(JWT_SECRET)\n\n  return token\n}\n\nexport async function verifySession(token: string): Promise<SessionPayload | null> {\n  try {\n    const verified = await jwtVerify(token, JWT_SECRET)\n    return verified.payload as unknown as SessionPayload\n  } catch (err) {\n    return null\n  }\n}\n\nexport async function setSessionCookie(token: string) {\n  const cookieStore = await cookies()\n  cookieStore.set(\"session\", token, {\n    httpOnly: true,\n    secure: true,   // Note: This requires HTTPS. If on localhost/http, login might fail.\n    sameSite: \"lax\",\n    maxAge: 7 * 24 * 60 * 60, // 7 days\n    path: \"/\",\n  })\n}\n\nexport async function getSessionFromCookie(): Promise<SessionPayload | null> {\n  try {\n    const cookieStore = await cookies()\n    const token = cookieStore.get(\"session\")?.value\n\n    if (!token) return null\n\n    return await verifySession(token)\n  } catch (err) {\n    return null\n  }\n}\n\nexport async function clearSessionCookie() {\n  const cookieStore = await cookies()\n  cookieStore.delete(\"session\")\n}"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AAAA;;;AAEA,MAAM,aAAa,IAAI,cAAc,MAAM,CAAC,QAAQ,GAAG,CAAC,UAAU,IAAI;AAQ/D,eAAe,cAAc,OAAuB;IACzD,qFAAqF;IACrF,MAAM,QAAQ,MAAM,IAAI,kKAAO,CAAC;QAAE,GAAG,OAAO;IAAC,GAC1C,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,MAClB,IAAI,CAAC;IAER,OAAO;AACT;AAEO,eAAe,cAAc,KAAa;IAC/C,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,sKAAS,EAAC,OAAO;QACxC,OAAO,SAAS,OAAO;IACzB,EAAE,OAAO,KAAK;QACZ,OAAO;IACT;AACF;AAEO,eAAe,iBAAiB,KAAa;IAClD,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,YAAY,GAAG,CAAC,WAAW,OAAO;QAChC,UAAU;QACV,QAAQ;QACR,UAAU;QACV,QAAQ,IAAI,KAAK,KAAK;QACtB,MAAM;IACR;AACF;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,YAAY;QAE1C,IAAI,CAAC,OAAO,OAAO;QAEnB,OAAO,MAAM,cAAc;IAC7B,EAAE,OAAO,KAAK;QACZ,OAAO;IACT;AACF;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,YAAY,MAAM,CAAC;AACrB"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\n\nexport const db =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: ['query'],\n  });\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = db;\n\n// --- THE COMPATIBILITY LAYER ---\n\nexport function getSql() {\n  return async (query: string, params: any[] = []) => {\n    // 1. Convert Postgres syntax ($1, $2, etc) to MySQL syntax (?)\n    let mysqlQuery = query.replace(/\\$\\d+/g, '?');\n\n    // 2. Convert Postgres 'ILIKE' (Case Insensitive) to MySQL 'LIKE' (Default is case insensitive)\n    mysqlQuery = mysqlQuery.replace(/ILIKE/gi, 'LIKE');\n\n    // 3. Remove \"RETURNING *\" statements\n    // MySQL crashes if you try to use RETURNING, so we strip it out.\n    // WARNING: This means INSERT/UPDATE operations won't return the new data immediately.\n    mysqlQuery = mysqlQuery.replace(/RETURNING \\*|RETURNING \\w+/gi, '');\n\n    try {\n      // 4. Execute the raw query using Prisma\n      // Note: We use db.$queryRawUnsafe because we are manually building the query string\n      const result = await db.$queryRawUnsafe(mysqlQuery, ...params);\n      \n      // 5. Ensure we return an array (Prisma sometimes returns objects for metadata)\n      if (Array.isArray(result)) {\n        return result;\n      } \n      \n      // If it's an INSERT/UPDATE result in MySQL, it's not an array of rows.\n      // We return an empty array to prevent the app from crashing when it tries to read result[0].\n      return [];\n      \n    } catch (error) {\n      console.error(\"SQL Adapter Error:\", error);\n      throw error;\n    }\n  };\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM;AAEC,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG;AAI7D,SAAS;IACd,OAAO,OAAO,OAAe,SAAgB,EAAE;QAC7C,+DAA+D;QAC/D,IAAI,aAAa,MAAM,OAAO,CAAC,UAAU;QAEzC,+FAA+F;QAC/F,aAAa,WAAW,OAAO,CAAC,WAAW;QAE3C,qCAAqC;QACrC,iEAAiE;QACjE,sFAAsF;QACtF,aAAa,WAAW,OAAO,CAAC,gCAAgC;QAEhE,IAAI;YACF,wCAAwC;YACxC,oFAAoF;YACpF,MAAM,SAAS,MAAM,GAAG,eAAe,CAAC,eAAe;YAEvD,+EAA+E;YAC/E,IAAI,MAAM,OAAO,CAAC,SAAS;gBACzB,OAAO;YACT;YAEA,uEAAuE;YACvE,6FAA6F;YAC7F,OAAO,EAAE;QAEX,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;IACF;AACF"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/app/api/admin/stats/route.ts"],"sourcesContent":["import { getSessionFromCookie } from \"@/lib/session\"\nimport { db } from \"@/lib/db\"\nimport { NextResponse } from \"next/server\"\n\nexport async function GET() {\n  try {\n    const session = await getSessionFromCookie()\n    \n    // ðŸ’¡ Fix 1: Cast role to string to avoid TypeScript error \n    // because \"admin\" isn't in your strict role definition yet.\n    if (!session || (session.role as string) !== \"admin\") {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    // 1. Fetch Counts\n    const totalClients = await db.user.count({ where: { role: 'client' } })\n    const totalNutritionists = await db.nutritionist.count()\n    const pendingVerifications = await db.nutritionist.count({ where: { verification_status: 'submitted' } })\n    \n    // 2. Calculate Revenue (Sum of all completed appointments)\n    const earnings = await db.appointment.aggregate({\n      where: { status: 'completed' },\n      _sum: { price: true }\n    })\n\n    // 3. Fetch Recent Activity (Last 5 Bookings)\n    const recentBookings = await db.appointment.findMany({\n      take: 5,\n      orderBy: { created_at: 'desc' },\n      include: {\n        client: { select: { name: true } },\n        // ðŸ’¡ Fix 2: 'nutritionist' relates to User directly, so we select 'name' directly.\n        // Removed the nested { user: ... } wrapper.\n        nutritionist: { select: { name: true } }\n      }\n    })\n\n    // 4. Mock System Load (Since we can't read actual VPS CPU from Node easily)\n    const systemHealth = {\n      status: 'Healthy',\n      uptime: process.uptime(),\n      dbConnection: 'Active'\n    }\n\n    return NextResponse.json({\n      stats: {\n        clients: totalClients,\n        nutritionists: totalNutritionists,\n        pending: pendingVerifications,\n        revenue: earnings._sum.price || 0,\n      },\n      recentActivity: recentBookings,\n      system: systemHealth\n    })\n\n  } catch (error) {\n    console.error(\"Admin Stats Error:\", error)\n    return NextResponse.json({ error: \"Internal Error\" }, { status: 500 })\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,wIAAoB;QAE1C,2DAA2D;QAC3D,4DAA4D;QAC5D,IAAI,CAAC,WAAW,AAAC,QAAQ,IAAI,KAAgB,SAAS;YACpD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,kBAAkB;QAClB,MAAM,eAAe,MAAM,iHAAE,CAAC,IAAI,CAAC,KAAK,CAAC;YAAE,OAAO;gBAAE,MAAM;YAAS;QAAE;QACrE,MAAM,qBAAqB,MAAM,iHAAE,CAAC,YAAY,CAAC,KAAK;QACtD,MAAM,uBAAuB,MAAM,iHAAE,CAAC,YAAY,CAAC,KAAK,CAAC;YAAE,OAAO;gBAAE,qBAAqB;YAAY;QAAE;QAEvG,2DAA2D;QAC3D,MAAM,WAAW,MAAM,iHAAE,CAAC,WAAW,CAAC,SAAS,CAAC;YAC9C,OAAO;gBAAE,QAAQ;YAAY;YAC7B,MAAM;gBAAE,OAAO;YAAK;QACtB;QAEA,6CAA6C;QAC7C,MAAM,iBAAiB,MAAM,iHAAE,CAAC,WAAW,CAAC,QAAQ,CAAC;YACnD,MAAM;YACN,SAAS;gBAAE,YAAY;YAAO;YAC9B,SAAS;gBACP,QAAQ;oBAAE,QAAQ;wBAAE,MAAM;oBAAK;gBAAE;gBACjC,mFAAmF;gBACnF,4CAA4C;gBAC5C,cAAc;oBAAE,QAAQ;wBAAE,MAAM;oBAAK;gBAAE;YACzC;QACF;QAEA,4EAA4E;QAC5E,MAAM,eAAe;YACnB,QAAQ;YACR,QAAQ,QAAQ,MAAM;YACtB,cAAc;QAChB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;gBACL,SAAS;gBACT,eAAe;gBACf,SAAS;gBACT,SAAS,SAAS,IAAI,CAAC,KAAK,IAAI;YAClC;YACA,gBAAgB;YAChB,QAAQ;QACV;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACtE;AACF"}}]
}