{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\n\nexport const db =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: ['query'],\n  });\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = db;\n\n// --- THE COMPATIBILITY LAYER ---\n\nexport function getSql() {\n  return async (query: string, params: any[] = []) => {\n    // 1. Convert Postgres syntax ($1, $2, etc) to MySQL syntax (?)\n    let mysqlQuery = query.replace(/\\$\\d+/g, '?');\n\n    // 2. Convert Postgres 'ILIKE' (Case Insensitive) to MySQL 'LIKE' (Default is case insensitive)\n    mysqlQuery = mysqlQuery.replace(/ILIKE/gi, 'LIKE');\n\n    // 3. Remove \"RETURNING *\" statements\n    // MySQL crashes if you try to use RETURNING, so we strip it out.\n    // WARNING: This means INSERT/UPDATE operations won't return the new data immediately.\n    mysqlQuery = mysqlQuery.replace(/RETURNING \\*|RETURNING \\w+/gi, '');\n\n    try {\n      // 4. Execute the raw query using Prisma\n      // Note: We use db.$queryRawUnsafe because we are manually building the query string\n      const result = await db.$queryRawUnsafe(mysqlQuery, ...params);\n      \n      // 5. Ensure we return an array (Prisma sometimes returns objects for metadata)\n      if (Array.isArray(result)) {\n        return result;\n      } \n      \n      // If it's an INSERT/UPDATE result in MySQL, it's not an array of rows.\n      // We return an empty array to prevent the app from crashing when it tries to read result[0].\n      return [];\n      \n    } catch (error) {\n      console.error(\"SQL Adapter Error:\", error);\n      throw error;\n    }\n  };\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM;AAEC,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG;AAI7D,SAAS;IACd,OAAO,OAAO,OAAe,SAAgB,EAAE;QAC7C,+DAA+D;QAC/D,IAAI,aAAa,MAAM,OAAO,CAAC,UAAU;QAEzC,+FAA+F;QAC/F,aAAa,WAAW,OAAO,CAAC,WAAW;QAE3C,qCAAqC;QACrC,iEAAiE;QACjE,sFAAsF;QACtF,aAAa,WAAW,OAAO,CAAC,gCAAgC;QAEhE,IAAI;YACF,wCAAwC;YACxC,oFAAoF;YACpF,MAAM,SAAS,MAAM,GAAG,eAAe,CAAC,eAAe;YAEvD,+EAA+E;YAC/E,IAAI,MAAM,OAAO,CAAC,SAAS;gBACzB,OAAO;YACT;YAEA,uEAAuE;YACvE,6FAA6F;YAC7F,OAAO,EAAE;QAEX,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;IACF;AACF"}},
    {"offset": {"line": 194, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/lib/mail.ts"],"sourcesContent":["import nodemailer from \"nodemailer\"\n\n// Configure this with your email provider details\nconst transporter = nodemailer.createTransport({\n  service: \"gmail\", \n  // If using something else like SendGrid, comment out 'service' and use host/port:\n  // host: \"smtp.example.com\",\n  // port: 587,\n  auth: {\n    user: process.env.SMTP_USER,\n    pass: process.env.SMTP_PASS,\n  },\n})\n\nexport async function sendVerificationEmail(email: string, token: string) {\n  const confirmLink = `${process.env.NEXT_PUBLIC_APP_URL}/verify?token=${token}`\n\n  await transporter.sendMail({\n    from: '\"AfyaDiet Security\" <no-reply@afyadietsolutions.co.ke>',\n    to: email,\n    subject: \"Verify your AfyaDiet Account\",\n    html: `\n      <div style=\"font-family: Arial, sans-serif; padding: 20px; color: #333;\">\n        <h2 style=\"color: #16a34a;\">Welcome to AfyaDiet!</h2>\n        <p>Please confirm your email address to activate your account.</p>\n        <br/>\n        <a href=\"${confirmLink}\" style=\"background: #16a34a; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold;\">Verify Email</a>\n        <br/><br/>\n        <p style=\"font-size: 12px; color: #666;\">Or copy this link: ${confirmLink}</p>\n      </div>\n    `,\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,kDAAkD;AAClD,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;IAC7C,SAAS;IACT,kFAAkF;IAClF,4BAA4B;IAC5B,aAAa;IACb,MAAM;QACJ,MAAM,QAAQ,GAAG,CAAC,SAAS;QAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC7B;AACF;AAEO,eAAe,sBAAsB,KAAa,EAAE,KAAa;IACtE,MAAM,cAAc,uEAAmC,cAAc,EAAE,OAAO;IAE9E,MAAM,YAAY,QAAQ,CAAC;QACzB,MAAM;QACN,IAAI;QACJ,SAAS;QACT,MAAM,CAAC;;;;;iBAKM,EAAE,YAAY;;oEAEqC,EAAE,YAAY;;IAE9E,CAAC;IACH;AACF"}},
    {"offset": {"line": 233, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/app/api/auth/signup/route.ts"],"sourcesContent":["import { db } from \"@/lib/db\"\nimport { NextResponse } from \"next/server\"\nimport bcrypt from \"bcrypt\"\nimport crypto from \"crypto\"\nimport { sendVerificationEmail } from \"@/lib/mail\"\n\nexport async function POST(req: Request) {\n  try {\n    const { fullName, email, password, role } = await req.json()\n\n    if (!email || !password || !fullName || !role) {\n      return NextResponse.json({ error: \"Missing fields\" }, { status: 400 })\n    }\n\n    const existingUser = await db.user.findUnique({ where: { email } })\n    if (existingUser) {\n      return NextResponse.json({ error: \"Email already in use\" }, { status: 400 })\n    }\n\n    const hashedPassword = await bcrypt.hash(password, 10)\n    \n    // Generate a random token\n    const verificationToken = crypto.randomBytes(32).toString(\"hex\")\n\n    await db.user.create({\n      data: {\n        name: fullName,\n        email,\n        password_hash: hashedPassword,\n        role,\n        verification_token: verificationToken,\n        email_verified: null // Null means not verified\n      },\n    })\n\n    // Send the email (don't await it to keep response fast)\n    try {\n        await sendVerificationEmail(email, verificationToken)\n    } catch (emailError) {\n        console.error(\"Failed to send email:\", emailError)\n        // We still return success for signup, user can request resend later if needed\n    }\n\n    return NextResponse.json({ \n      success: true, \n      message: \"Account created! Please check your email to verify.\" \n    })\n\n  } catch (error) {\n    console.error(\"Signup error:\", error)\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,MAAM,IAAI,IAAI;QAE1D,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,YAAY,CAAC,MAAM;YAC7C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,eAAe,MAAM,iHAAE,CAAC,IAAI,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE;YAAM;QAAE;QACjE,IAAI,cAAc;YAChB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAuB,GAAG;gBAAE,QAAQ;YAAI;QAC5E;QAEA,MAAM,iBAAiB,MAAM,gHAAM,CAAC,IAAI,CAAC,UAAU;QAEnD,0BAA0B;QAC1B,MAAM,oBAAoB,gHAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC;QAE1D,MAAM,iHAAE,CAAC,IAAI,CAAC,MAAM,CAAC;YACnB,MAAM;gBACJ,MAAM;gBACN;gBACA,eAAe;gBACf;gBACA,oBAAoB;gBACpB,gBAAgB,KAAK,0BAA0B;YACjD;QACF;QAEA,wDAAwD;QACxD,IAAI;YACA,MAAM,IAAA,sIAAqB,EAAC,OAAO;QACvC,EAAE,OAAO,YAAY;YACjB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,8EAA8E;QAClF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;QACX;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}