{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\n\nexport const db =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: ['query'],\n  });\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = db;\n\n// --- THE COMPATIBILITY LAYER ---\n\nexport function getSql() {\n  return async (query: string, params: any[] = []) => {\n    // 1. Convert Postgres syntax ($1, $2, etc) to MySQL syntax (?)\n    let mysqlQuery = query.replace(/\\$\\d+/g, '?');\n\n    // 2. Convert Postgres 'ILIKE' (Case Insensitive) to MySQL 'LIKE' (Default is case insensitive)\n    mysqlQuery = mysqlQuery.replace(/ILIKE/gi, 'LIKE');\n\n    // 3. Remove \"RETURNING *\" statements\n    // MySQL crashes if you try to use RETURNING, so we strip it out.\n    // WARNING: This means INSERT/UPDATE operations won't return the new data immediately.\n    mysqlQuery = mysqlQuery.replace(/RETURNING \\*|RETURNING \\w+/gi, '');\n\n    try {\n      // 4. Execute the raw query using Prisma\n      // Note: We use db.$queryRawUnsafe because we are manually building the query string\n      const result = await db.$queryRawUnsafe(mysqlQuery, ...params);\n      \n      // 5. Ensure we return an array (Prisma sometimes returns objects for metadata)\n      if (Array.isArray(result)) {\n        return result;\n      } \n      \n      // If it's an INSERT/UPDATE result in MySQL, it's not an array of rows.\n      // We return an empty array to prevent the app from crashing when it tries to read result[0].\n      return [];\n      \n    } catch (error) {\n      console.error(\"SQL Adapter Error:\", error);\n      throw error;\n    }\n  };\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM;AAEC,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG;AAI7D,SAAS;IACd,OAAO,OAAO,OAAe,SAAgB,EAAE;QAC7C,+DAA+D;QAC/D,IAAI,aAAa,MAAM,OAAO,CAAC,UAAU;QAEzC,+FAA+F;QAC/F,aAAa,WAAW,OAAO,CAAC,WAAW;QAE3C,qCAAqC;QACrC,iEAAiE;QACjE,sFAAsF;QACtF,aAAa,WAAW,OAAO,CAAC,gCAAgC;QAEhE,IAAI;YACF,wCAAwC;YACxC,oFAAoF;YACpF,MAAM,SAAS,MAAM,GAAG,eAAe,CAAC,eAAe;YAEvD,+EAA+E;YAC/E,IAAI,MAAM,OAAO,CAAC,SAAS;gBACzB,OAAO;YACT;YAEA,uEAAuE;YACvE,6FAA6F;YAC7F,OAAO,EAAE;QAEX,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sBAAsB;YACpC,MAAM;QACR;IACF;AACF"}},
    {"offset": {"line": 128, "column": 0}, "map": {"version":3,"sources":["file:///var/www/html/afyadiet/app/api/auth/login/route.ts"],"sourcesContent":["import { db } from \"@/lib/db\"\nimport { NextResponse } from \"next/server\"\nimport bcrypt from \"bcrypt\"\nimport { sign } from \"jsonwebtoken\"\nimport { serialize } from \"cookie\"\n\nconst SECRET = process.env.JWT_SECRET || \"super-secret-key\"\n\nexport async function POST(req: Request) {\n  try {\n    const { email, password } = await req.json()\n\n    if (!email || !password) {\n      return NextResponse.json({ error: \"Missing fields\" }, { status: 400 })\n    }\n\n    const user = await db.user.findUnique({ where: { email } })\n\n    if (!user) {\n      return NextResponse.json({ error: \"Invalid credentials\" }, { status: 401 })\n    }\n\n    // Check Verification\n    if (!user.email_verified) {\n      return NextResponse.json({ error: \"Please verify your email address first.\" }, { status: 403 })\n    }\n\n    const passwordMatch = await bcrypt.compare(password, user.password_hash)\n\n    if (!passwordMatch) {\n      return NextResponse.json({ error: \"Invalid credentials\" }, { status: 401 })\n    }\n\n    // Create Token\n    const token = sign(\n      { userId: user.id, email: user.email, role: user.role, name: user.name },\n      SECRET,\n      { expiresIn: \"7d\" }\n    )\n\n    // ðŸ’¡ FIX: Changed cookie name from \"session_token\" to \"session\"\n    const cookie = serialize(\"session\", token, {\n      httpOnly: true,\n      secure: true, // Revert to true since your domain is HTTPS\n      sameSite: \"lax\",\n      maxAge: 60 * 60 * 24 * 7, // 1 week\n      path: \"/\",\n    })\n\n    const response = NextResponse.json({\n      success: true,\n      user: {\n        id: user.id,\n        name: user.name,\n        email: user.email,\n        role: user.role,\n        avatar_url: user.avatar_url\n      },\n    })\n\n    response.headers.set(\"Set-Cookie\", cookie)\n    return response\n\n  } catch (error) {\n    console.error(\"Login error:\", error)\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;AAElC,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAE1C,IAAI,CAAC,SAAS,CAAC,UAAU;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,OAAO,MAAM,iHAAE,CAAC,IAAI,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE;YAAM;QAAE;QAEzD,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,qBAAqB;QACrB,IAAI,CAAC,KAAK,cAAc,EAAE;YACxB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0C,GAAG;gBAAE,QAAQ;YAAI;QAC/F;QAEA,MAAM,gBAAgB,MAAM,gHAAM,CAAC,OAAO,CAAC,UAAU,KAAK,aAAa;QAEvE,IAAI,CAAC,eAAe;YAClB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,eAAe;QACf,MAAM,QAAQ,IAAA,+IAAI,EAChB;YAAE,QAAQ,KAAK,EAAE;YAAE,OAAO,KAAK,KAAK;YAAE,MAAM,KAAK,IAAI;YAAE,MAAM,KAAK,IAAI;QAAC,GACvE,QACA;YAAE,WAAW;QAAK;QAGpB,gEAAgE;QAChE,MAAM,SAAS,IAAA,sJAAS,EAAC,WAAW,OAAO;YACzC,UAAU;YACV,QAAQ;YACR,UAAU;YACV,QAAQ,KAAK,KAAK,KAAK;YACvB,MAAM;QACR;QAEA,MAAM,WAAW,gJAAY,CAAC,IAAI,CAAC;YACjC,SAAS;YACT,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,MAAM,KAAK,IAAI;gBACf,OAAO,KAAK,KAAK;gBACjB,MAAM,KAAK,IAAI;gBACf,YAAY,KAAK,UAAU;YAC7B;QACF;QAEA,SAAS,OAAO,CAAC,GAAG,CAAC,cAAc;QACnC,OAAO;IAET,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF"}}]
}